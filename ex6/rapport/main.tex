% debut d'un fichier latex standard
\documentclass[a4paper,12pt,twoside]{article}

\usepackage{lipsum}

% pour l'inclusion de figures en eps,pdf,jpg
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{wrapfig}
% quelques symboles mathematiques en plus
\usepackage{amsmath}
\usepackage{amsthm} % Pour les preuves
% le tout en langue francaise
%\usepackage[french]{babel}
% on peut ecrire directement les caracteres avec l'accent
% a utiliser sur Linux/Windows
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
% a utiliser sur le Mac
%\usepackage[applemac]{inputenc}
% pour l'inclusion de links dans le document
\usepackage[colorlinks,bookmarks=false,linkcolor=blue,urlcolor=blue]{hyperref}
\usepackage{siunitx}
% pour les degrés
\usepackage{textcomp}
\paperheight=297mm
\paperwidth=210mm

\setlength{\textheight}{235mm}
\setlength{\topmargin}{-1.2cm} % pour centrer la page verticalement
%\setlength{\footskip}{5mm}
\setlength{\textwidth}{15cm}
\setlength{\oddsidemargin}{0.56cm}
\setlength{\evensidemargin}{0.56cm}

\pagestyle{plain}

% quelques abreviations utiles
\def \be {\begin{equation}}
\def \ee {\end{equation}}
\def \dd  {{\rm d}}

\newcommand{\mail}[1]{{\href{mailto:#1}{#1}}}
\newcommand{\ftplink}[1]{{\href{ftp://#1}{#1}}}

\newcommand{\illabel}[1]{ ~ \refstepcounter{equation}(\theequation)\label{#1}} % Ecrit une équation dans le texte, numérotés.
\newcommand{\mbf}[1]{\mathbf{#1}} % bold font in math
\newcommand{\grad}[1]{\nabla#1}
\newcommand{\Div}[1]{\nabla\cdot\mathbf{#1}}
\newcommand{\rot}[1]{\nable\cross\mathbf{#1}}
\newcommand{\bracket}[1]{\left(#1\right)}
\newcommand{\sqbracket}[1]{\left[#1\right]}
\newcommand{\lapl}[1]{\Delta#1}

%
% latex SqueletteRapport.tex      % compile la source LaTeX
% xdvi SqueletteRapport.dvi &     % visualise le resultat
% dvips -t a4 -o SqueletteRapport.ps SqueletteRapport % produit un PostScript
% ps2pdf SqueletteRapport.ps      % convertit en pdf

% pdflatex SqueletteRapport.pdf    % compile et produit un pdf
% \message{================> TAILLE DE LA POLICE EN CM \printinunitsof{cm}\prntlen{\textwidth}}

% ======= Le document commence ici ======

\begin{document}
% Le titre, l'auteur et la date
\title{Electrostatique\\{\small Physique Numérique I}\\{\small Rapport 6}}
\date{\today}
\author{Delphine Martres et Damien Korber\\{\small \mail{delphine.martres@epfl.ch} et \mail{damien.korber@epfl.ch}}}

\maketitle
\tableofcontents % Table des matieres


% Quelques options pour les espacements entre lignes, l'identation
% des nouveaux paragraphes, et l'espacement entre paragraphes
\baselineskip=16pt
\parindent=15pt
\parskip=5pt
\newpage

%%%% ON COMMENCE A ECRIRE D'ICI

% \section{Introduction} %TODO: Faire une introduction

\section{Differential equation and variational form}
  \subsection{Differential equation for the potential $\phi(\vec{x})$} \label{sec:equa-diff-phi}
    This section will derive the equation that describes the problem.

    \begin{align*}
      \intertext{First, one of Maxwell's equation is used}
      \nabla\cdot\mathbf{D} &= \rho\bracket{\mathbf{x}} \\
      \intertext{where $\mathbf{D}=\epsilon_0\epsilon_r\mathbf{E}$ is the electric displacement field.}
      \nabla\cdot\bracket{\epsilon_0\epsilon_r\mathbf{E}} &= \rho\bracket{\mathbf{x}} \\
      \nabla\cdot\bracket{\epsilon_r\mathbf{E}} &= \frac{\rho\bracket{\mathbf{x}}}{\epsilon_0} \\
      \epsilon_r\Div{E} + \mathbf{E}\cdot\nabla\epsilon_r &= \frac{\rho\bracket{\mbf{x}}}{\epsilon_0} \\
      \intertext{We know that $\mbf{E}$ derive from a potential $\phi$ such that $\mathbf{E}=-\grad{\phi}$. Thus}
      -\epsilon_r\lapl{\phi}-\grad{\phi}\grad{\epsilon_r} &= \frac{\rho\bracket{\mbf{x}}}{\epsilon_0}
      \intertext{This leads to equation \eqref{eq:equa-diff}.}
    \end{align*}
    \begin{equation}
      \centering
      \boxed{\grad{\phi}\grad{\epsilon_r} + \epsilon_r\lapl{\phi} = -\frac{\rho\bracket{\mbf{x}}}{\epsilon_0}}
      \label{eq:equa-diff}
    \end{equation}

  \subsection{Variational form}
    To numerically solve equation \eqref{eq:equa-diff}, the variational form of the problem must be found.

    \begin{align*}
      \intertext{Let $\eta\bracket{\mbf{x}}\subset\mathcal{C}^1\bracket{\Omega}$, $\eta\bracket{\mbf{x}}=0~ \forall \mbf{x}\in\partial\Omega$. Multiply both sides of equation \eqref{eq:equa-diff} by $\eta\bracket{\mbf{x}}$, and integrate over the volume $\Omega$.}
      \int_\Omega \eta\bracket{\mbf{x}}\grad{\phi}\grad{\epsilon_r}d\mbf{x} + \int_\Omega \eta\bracket{\mbf{x}}\epsilon_r\lapl{\phi}d\mbf{x} &= -\int_\Omega \eta\bracket{\mbf{x}}\frac{\rho\bracket{\mbf{x}}}{\epsilon_0}d\mbf{x}
      \intertext{By using formula $\nabla\cdot\bracket{f\nabla g} = \grad{f}\cdot\grad{g} + f\lapl{g}$ where $f=\eta\epsilon_r$ et $g=\phi$:}
      \nabla\cdot\bracket{\eta\epsilon_r\grad{\phi}} &= \grad{\bracket{\eta\epsilon_r}}\cdot\grad{\phi} + \eta\epsilon_r\lapl{\phi} \\
      &= \epsilon_r\grad{\eta}\cdot\grad{\phi} + \eta\grad{\epsilon_r}\cdot\grad{\phi} + \eta\epsilon_r\lapl{\phi} \\
      \Rightarrow \int_\Omega\bracket{\eta\bracket{\mbf{x}}\grad{\phi}\cdot\grad{\epsilon_r} + \eta\bracket{\mbf{x}}\epsilon_r\lapl{\phi}}d\mbf{x} &= \int_\Omega\bracket{\underbrace{\nabla\cdot\bracket{\eta\epsilon_r\grad{\phi}}}_* - \epsilon_r\grad{\eta}\cdot\grad{\phi}}d\mbf{x}
      \intertext{Using Gauss' theorem: $*= \int_{\partial\Omega}\eta\epsilon_r\grad{\phi}\cdot d\mbf{\sigma} = 0$ because $\eta\bracket{\mbf{x}}=0~\forall\mbf{x}\in\partial\Omega$ by definition.}
    \end{align*}
    \begin{equation}
      \centering
      \Rightarrow \boxed{\int_\Omega\epsilon_r\grad{\eta}\cdot\grad{\phi}d\mbf{x} = \int_\Omega\eta\bracket{\mbf{x}}\frac{\rho\bracket{\mbf{x}}}{\epsilon_0}d\mbf{x}}
      \label{eq:variational-form}
    \end{equation}

  \subsection{Special case: cylinder} %TODO : Faut changer le titre, il pue.
    From now, the exercice will focus on a cylinder of radius $R$ and of length $L_z$ long enough to neglect the side-effects.
    Thus, $\phi\bracket{r}$, $\epsilon_r\bracket{r}$ and $\rho_\text{lib}\bracket{r}$ only depend on the radius of the cylinder, so $\grad{\eta}=\frac{d\eta}{dr}$ and $\grad{\phi}=\frac{d\phi}{dr}$.
    From equation \eqref{eq:variational-form}, the variational form of the problem can be expressed in cylindrical coordinates, which gives equation \eqref{eq:variational-form-cylindrical}.

    \begin{equation}
      \centering
      \boxed{\int_0^R r\epsilon_r\bracket{r}\frac{d\eta\bracket{r}}{dr}\frac{d\phi\bracket{r}}{dr}dr = \frac{1}{\epsilon_0}\int_0^R r\eta\bracket{r}\rho\bracket{r} dr}
      \label{eq:variational-form-cylindrical}
    \end{equation}

    Note that $r$ is added to the integral, coming from the change of variable into cylindrical coordinates.

\section{Finite elements}
  The problem need to be discretized to get a numerical solution.
  $\phi$ and $\eta$ must be expressed in a discretized way.
  Consider $\Lambda_i\bracket{r}$, the polynomials as represented on figure \ref{fig:lambda}.
  These function are used to approximate $\phi$ and $\eta$, which are given by equation \eqref{eq:approx-phi-eta}.

  \begin{equation}
    \phi\bracket{r}=\sum_j\phi_j\Lambda_j\bracket{r}~\text{and}~\eta\bracket{r}=\sum_i\eta_i\Lambda_i\bracket{r}
    \label{eq:approx-phi-eta} %TODO : Vérifier les indices. (être cohérant avec la suite surtout)
  \end{equation}

  \begin{figure}[h]
    \centering
    \includegraphics[width=0.6\textwidth]{graphs/lambda.pdf}
    \caption{Scheme of the lambda functions}
    \label{fig:lambda}
  \end{figure}

  Using equations \eqref{eq:variational-form-cylindrical} and \eqref{eq:approx-phi-eta}, the problem can be discretized as equation \eqref{eq:discret-gen}.

  \begin{equation}
    \sum_i\eta_i\sum_j\bracket{\int_0^R r\epsilon_r\frac{d\Lambda_i}{dr}\frac{d\Lambda_j}{dr}dr}\phi_j = \sum_i\eta_i\bracket{\int_0^R\Lambda_i\frac{\rho}{\epsilon_0}dr}
    \label{eq:discret-gen}
  \end{equation}

  By identification, a system of linear equation $A\mbf{\phi}=\mbf{b}$ can be deduced, as given by equation \eqref{eq:discret-final}.

  \begin{equation}
    \sum_j\bracket{\underbrace{\int_0^R r\epsilon_r\frac{d\Lambda_i}{dr}\frac{d\Lambda_j}{dr}dr}_{A_{ij}}}\phi_j = \underbrace{\int_0^R \Lambda_i\frac{\rho}{\epsilon_0}dr}_{b_i}
    \label{eq:discret-final}
  \end{equation}



  \subsection{Writing matrix $A$ and vector $\mbf{b}$ of the linear system $A\mbf{\phi}=\mbf{b}$}\label{sec:writing-A-b1} %TODO : Changer le titre, celui-là pue.
  %TODO : Ecrire le développement pour A.
  First, the matrix $A$ needs to be explicited.

  %TODO : Mettre explicitement cette equation pour la règle du trapèze. J'en ai besoin pour b, et tu l'utilises pour A.
  \begin{equation}
    \int_a^b f\bracket{x}dx = \bracket{b-a}\frac{f\bracket{b} + f\bracket{a}}{2}
    \label{eq:trapezoidal-rule}
  \end{equation}


  Now, vector $\mbf{b}$ needs to be explicited.

  \begin{align*}
    b_i &= \int_0^R r\Lambda_i\frac{\rho\bracket{r}}{\epsilon_0}dr = \sum_{k=1}^N \int_{r_{k}}^{r_{k+1}}r\Lambda_i\frac{\rho\bracket{r}}{\epsilon_0}dr
    \intertext{Knowing that $\Lambda_i\bracket{r_k} = \delta_{ik}$ and using the trapezoidal rule (Eq. \eqref{eq:trapezoidal-rule}):}
    &= \sum_{k=1}^N \frac{h_k}{2}\bracket{r_{k+1}\Lambda_i\bracket{r_{k+1}}\frac{\rho\bracket{r_{k+1}}}{\epsilon_0} + r_k\Lambda_i\bracket{r_k}\frac{\rho\bracket{r_k}}{\epsilon_0}} \\
    &= \frac{h_{i-1}}{2}r_i\frac{\rho\bracket{r_i}}{\epsilon_0} + \frac{h_i}{2}r_i\frac{\rho\bracket{r_i}}{\epsilon_0} = \frac{r_i\rho\bracket{r_i}}{2\epsilon_0}\bracket{h_{i-1} + h_i}
  \end{align*}

  \begin{equation}
    \Rightarrow \boxed{b_i = \frac{r_i\rho\bracket{r_i}}{2\epsilon_0}\bracket{h_{i-1} + h_i}}
    \label{eq:b-final}
  \end{equation}

  \section{Trivial case}

  \begin{figure}
   \centering
   \includegraphics[width=0.5\textwidth]{graphs/c_phi.eps}
   \label{cphi}
  \end{figure}

  \begin{figure}
   \centering
   \includegraphics[width=0.5\textwidth]{graphs/c_Er.eps}
   \label{cEr}
  \end{figure}

  \section{Non-trivial case}
  In this section, $b=\SI{0.02}{\m}$ and $R=\SI{0.12}{\m}$.
  Furthermore, the number of nodes on the horizontal axis and the vertical axis are linked by this relation: $N_2 = 2N_1$.

  \paragraph{UN EXEMPLE  DE SOLUTION POUR PHI ET ER} \lipsum[1-1]

  \begin{figure}[h]
    \centering
    \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{graphs/exd1-evoPhi}
      \caption{Evolution of $\phi\bracket{r}$}
      \label{fig:d1-evoPhi}
    \end{subfigure}
    ~
    \begin{subfigure}{0.45\textwidth}
      \includegraphics[width=\textwidth]{graphs/exd1-evoEr}
      \caption{Evolution of $E(r)$}
      \label{fig:d1-evoEr}
    \end{subfigure}
    \caption{Evolution of two quantities with respect to the distance $r$ from the center of the cylinder, for four simulations}
    \label{fig:d1-evo}
  \end{figure}

  \paragraph{CONVERGENCE PHI} \lipsum[1-1]

  \begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{graphs/exd1-convPhi.eps}
    \caption{Convergence of $\phi\bracket{r=b}$ for ten simulations}
    \label{fig:d1-conv}
  \end{figure}

  \paragraph{VERIFICATION DE DIV(D)=RHOLIB} \lipsum[1-1]
  % Maxwell's law used at the beginning of section \ref{sec:equa-diff-establishment} states that the divergence of the displacement field is equal to the charge density.
  % However, this charge density considers every charges of the environment: free charges and polarisation charges.


  \begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{graphs/exd2-diff.eps}
    \caption{Evolution of two quantities with respect to the distance $r$ from the center of the cylinder. Note that $N_2=2N_1=200$ for this simulation.} %TODO : La caption pue, non ?
    \label{fig:d2}
  \end{figure}

  \section{Supplement} %TODO : Le titre de la section pue.
    \subsection{Combination of the trapezoidal rule and the middle point rule}
      Section \ref{sec:writing-A-b1} described a method to describe the elements of the matrix $A$ and the vector $\mbf{b}$.
      These elements contained integral, which needed to be numerically approximated.
      To achieve this, the trapezoidal rule was used.
      An alternative method can be used to compute these integrals, which is a combination of the trapezoidal rule and the middle point rule.
      Let $f\bracket{x}$ be an integrable function.
      Then, the trapezoidal-middle point rule is given by equation \eqref{eq:int-trapeze-milieu}, where $p\in[0,1]$ is a parameter. Note that $p=1$ gives the trapezoidal rule.

      \begin{equation}
        \int_{x_k}^{x_{k+1}}f\bracket{x}dx \approx h_k\bracket{p\frac{f\bracket{x_k} + f\bracket{x_{k+1}}}{2} + \bracket{1-p}f\bracket{\frac{x_k + x_{k+1}}{2}}}
        \label{eq:int-trapeze-milieu}
      \end{equation}

      The whole process to obtain $A$ and $\mbf{b}$ will not be described, as it is similar to what was described in section \ref{sec:writing-A-b1}.
      Only the final results will be given.
      The matrix $A$ is described by %TODO: Compléter cette phrase et ajouter la matrice A.

      The vector $b_i$ is described by equation \eqref{eq:b-final2}.

      \begin{equation}
        b_i = \frac{1}{2\epsilon_0}\sqbracket{pr_i\rho\bracket{r_i}\bracket{h_i + h_{i-1}} + \bracket{1-p}\bracket{h_{i-1}\alpha_{i-1}\rho\bracket{\alpha_{i-1}} + h_i\alpha_i\rho\bracket{\alpha_i}}}
        \label{eq:b-final2}
      \end{equation}

      with $\alpha_k = \frac{r_k + r_{k+1}}{2}$.



\end{document}
